# peanut-ui Development Rules

**Version:** 0.0.2 | **Updated:** December 16, 2025

## üö´ Random

- **Never open SVG files** - it crashes you. Only read jpeg, png, gif, or webp.
- **Never run jq command** - it crashes you.
- **Never run sleep** from command line - it hibernates pc.
- **Do not generate .md files** unless explicity told to do so.
- **Error messages**, any error being shown in the ui should be user friendly and easy to understand, and any error being logged in consoles and sentry should be descriptive for developers to help with debugging
- **Never add AI co-author to commits** - do not add "Co-Authored-By" lines for AI assistants in git commits

## üíª Code Quality

- **Boy scout rule**: leave code better than you found it.
- **DRY** - do not repeat yourself. Reuse existing code and abstract shared functionality. Less code is better code.
- this also means to use shared consts (e.g. check src/constants)
- **Separate business logic from interface** - this is important for readability, debugging and testability.
- **Reuse existing components and functions** - don't hardcode hacky solutions.
- **Warn about breaking changes** - when making changes, ensure you're not breaking existing functionality, and if there's a risk, explicitly WARN about it.
- **Mention refactor opportunities** - if you notice an opportunity to refactor or improve existing code, mention it. DO NOT make any changes you were not explicitly told to do. Only mention the potential change to the user.
- **Performance is important** - cache where possible, make sure to not make unnecessary re-renders or data fetching.
- **Flag breaking changes** - always flag if changes done in Frontend are breaking and require action on Backend (or viceversa)

## üîó URL as State (Critical for UX)

- **URL is source of truth** - use query parameters for user-facing state that should survive navigation, refresh, or sharing (step indicators, amounts, filters, view modes, selected items)
- **Use nuqs library** - always use `useQueryStates` from [nuqs](https://nuqs.dev) for type-safe URL state management. never manually parse/set query params with router.push or URLSearchParams
- **Enable deep-linking** - users should be able to share or bookmark URLs mid-flow (e.g. `?step=inputAmount&amount=500&currency=ARS`)
- **Proper navigation** - URL state enables correct back/forward browser button behavior
- **Multi-step flows** - the URL should always reflect current step and relevant data, making the app behave like a proper web app, not a trapped SPA
- **Reserve useState for ephemeral UI** - only use React useState for truly transient state:
    - loading spinners and skeleton states
    - modal open/close state
    - form validation errors (unless they should persist)
    - hover/focus states
    - temporary UI animations
- **Don't URL-ify everything** - API responses, user authentication state, and internal component state generally shouldn't be in the URL unless they're user-facing and shareable
- **Type safety** - define parsers for query params (e.g. `parseAsInteger`, `parseAsStringEnum`) to ensure type safety and validation

## üö´ Import Rules (critical for build performance)

- **No barrel imports** - never use `import * as X from '@/constants'` or create index.ts barrel files. always import from specific files (e.g. `import { PEANUT_API_URL } from '@/constants/general.consts'`). barrel imports slow down builds and cause bundling issues.
- **No circular dependencies** - before adding imports, check if the target file imports from the current file. circular deps cause `Cannot access X before initialization` errors. move shared types to `interfaces.ts` if needed.
- **No node.js packages in client components** - packages like `web-push`, `fs`, `crypto` (node) can't be used in `'use client'` files. use server actions or api routes instead.
- **Check for legacy code** - before importing from a file, check if it has TODO comments marking it as legacy/deprecated. prefer newer implementations.

## üö´ Export Rules (critical for build performance)

- **Do not export multiple stuff from same component**:
    - never export types or other utility methods from a component or a hook
    - for types always use a separate file if they need to be reused
    - and for utility/helper functions use a separate utils file to export them and use if they need to be reused
    - same for files with multiple components exported, do not export multiple components from same file and if you see this done anywhere in the code, abstract it to other file

## üß™ Testing

- **Test new code** - where tests make sense, test new code. Especially with fast unit tests.
- **Tests live with code** - tests should live where the code they test is, not in a separate folder
- **Run tests**: `npm test` (fast, ~5s)

## üìÅ Documentation

- **All docs go in `docs/`** (except root `README.md`)
- **Keep it concise** - docs should be kept quite concise. AI tends to make verbose logs. No one reads that, keep it short and informational.
- **Check existing docs** before creating new ones - merge instead of duplicate
- **Log significant changes** in `docs/CHANGELOG.md` following semantic versioning
- **Maintain PR.md for PRs** - When working on a PR, maintain a very concise `docs/PR.md` with:
    1. Summary of changes
    2. Risks (what might break)
    3. QA guidelines (what to test)

## üöÄ Performance

- **Cache where possible** - avoid unnecessary re-renders and data fetching
- **Fire simultaneous requests** - if you're doing multiple sequential awaits and they're not interdependent, fire them simultaneously
- **Service Worker cache version** - only bump `NEXT_PUBLIC_API_VERSION` for breaking API changes (see JSDoc in `src/app/sw.ts`). Users auto-migrate.
- **Gate heavy features in dev** - prefetching, precompiling, or eager loading of routes can add 5-10s to dev cold starts. wrap with `process.env.NODE_ENV !== 'development'` (e.g. `<link rel="prefetch" href="/qr-pay" />` in layout.tsx).

## üé® Design System

- **Live showcase**: visit `/dev/components` to see all components rendered with all variants and copy-paste code
- **Three layers**: Bruddle primitives (`src/components/0_Bruddle/`), Global shared components (`src/components/Global/`), and Tailwind custom classes (`tailwind.config.js`)

### Bruddle Primitives (`0_Bruddle/`)
- Button, Card (named export), BaseInput, BaseSelect, Checkbox, Divider, Title, Toast, PageContainer, CloudsBackground

### Global Shared Components (`Global/`)
- **Navigation**: NavHeader (back button + title), TopNavbar, Footer
- **Modals**: Modal (base @headlessui Dialog), ActionModal (with buttons/checkboxes/icons), Drawer (vaul bottom sheet)
- **Loading**: Loading (spinner), PeanutLoading (branded), PeanutFactsLoading (with fun facts)
- **Cards**: Card (with position prop for stacked lists), InfoCard, PeanutActionCard
- **Status**: StatusPill, StatusBadge, ErrorAlert, ProgressBar
- **Icons**: Icon component with 50+ icons ‚Äî `<Icon name="check" size={20} />`
- **Inputs**: AmountInput, ValidatedInput, CopyField, GeneralRecipientInput, TokenSelector
- **Utilities**: CopyToClipboard, AddressLink, ExternalWalletButton, ShareButton, Banner, MarqueeWrapper

### Color Names (misleading!)
- `purple-1` / `primary-1` = `#FF90E8` (pink, not purple)
- `primary-3` = `#EFE4FF` (lavender)
- `yellow-1` / `secondary-1` = `#FFC900`
- `green-1` = `#98E9AB`

### Key Rules
- **Button sizing trap**: `size="large"` is `h-10` (40px) ‚Äî SHORTER than default `h-13` (52px). never use for primary CTAs
- **Primary CTA**: `<Button variant="purple" shadowSize="4" className="w-full">` ‚Äî no size prop
- **Secondary CTA**: `<Button variant="stroke" className="w-full">`
- **Shadows**: always black `#000000`. use `shadowSize="4"` for action buttons
- **Border radius**: always `rounded-sm` (not rounded-lg or rounded-md)
- **Border stroke**: `border border-n-1` (1px black)
- **Links**: `text-black underline` ‚Äî never `text-purple-1` (pink)
- **Text hierarchy**: `text-n-1` primary, `text-grey-1` secondary
- **Two Card components**: `0_Bruddle/Card` (standalone containers, named export) vs `Global/Card` (stacked list items, default export)
- **Backgrounds**: `bg-peanut-repeat-normal` for waving peanut pattern
- **Messaging**: use "starter balance" for card deposits ‚Äî never "card balance" or "Peanut rewards"

### Page Layouts

- **Outer shell**: `flex min-h-[inherit] flex-col gap-8` ‚Äî NavHeader is first child
- **Centered content + CTA** (default): wrap content AND CTA in `<div className="my-auto flex flex-col gap-6">`. CTA must be INSIDE this div, never a sibling
- **Pinned footer CTA**: add `justify-between` to outer div, CTA as last child outside content
- **Never** use `space-y-*` on the outer flex div (conflicts with centering) ‚Äî use `gap-*` instead

## ‚úÖ Before Pushing

- **Format**: `pnpm prettier --write <changed-files>` then verify with `pnpm prettier --check .`
- **Typecheck**: `npm run typecheck` ‚Äî catches type errors that tests miss (tests don't run tsc)
- **Test**: `npm test` (fast, ~5s) ‚Äî all 17 suites must pass
- **Build** (if touching imports/types): `npm run build` to catch compile errors

## üìù Commits

- **Be descriptive**
- **Use emoji prefixes**: ‚ú® features, üêõ fixes, üìö docs, üöÄ infra, ‚ôªÔ∏è refactor, ‚ö° performance
