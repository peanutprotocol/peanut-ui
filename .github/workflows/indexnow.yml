name: Ping IndexNow

on:
    # Fires when Vercel (or any deployment) reports status to GitHub.
    # Only runs on successful production deploys, so crawlers always hit live content.
    deployment_status:
    # Allow manual trigger
    workflow_dispatch:

permissions:
    contents: read

jobs:
    ping:
        runs-on: ubuntu-latest
        # Only run on successful production deployments (skip preview/staging).
        # The condition is ignored for workflow_dispatch (no deployment_status context).
        if: >-
            github.event_name == 'workflow_dispatch' ||
            (github.event.deployment_status.state == 'success' &&
             github.event.deployment_status.environment == 'Production')
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: true
                  token: ${{ secrets.SUBMODULE_TOKEN }}

            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version-file: '.node-version'
                  cache: 'pnpm'

            - run: pnpm install --frozen-lockfile

            - name: Ping IndexNow
              env:
                  INDEXNOW_KEY: '054e10e6239a45cb2d06e92d669f5b6f'
              run: pnpm tsx scripts/ping-indexnow.ts
