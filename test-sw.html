<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SW Debug Panel</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            background: #0a0a0a;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
        }
        button:hover {
            background: #0088ee;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #00ff00;
        }
        .error {
            border-left-color: #ff0000;
            color: #ff6666;
        }
        .warning {
            border-left-color: #ffaa00;
            color: #ffcc66;
        }
        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
            font-size: 12px;
        }
        h2 {
            color: #00ccff;
        }
    </style>
</head>
<body>
    <h1>üîç Service Worker Debug Panel</h1>
    
    <div class="section">
        <h2>1. SW Registration Status</h2>
        <div id="sw-status">Checking...</div>
        <button onclick="checkSWStatus()">Refresh Status</button>
        <button onclick="forceUpdate()">Force Update SW</button>
        <button onclick="unregisterSW()">Unregister SW</button>
    </div>

    <div class="section">
        <h2>2. Cache Contents</h2>
        <div id="cache-info">Loading...</div>
        <button onclick="checkCaches()">Check Caches</button>
        <button onclick="clearAllCaches()">Clear All Caches</button>
    </div>

    <div class="section">
        <h2>3. Test API Fetch (via SW)</h2>
        <div id="fetch-result">Not tested yet</div>
        <button onclick="testAPIFetch()">Test User API</button>
        <button onclick="testOfflineMode()">Simulate Offline</button>
    </div>

    <div class="section">
        <h2>4. Console Logs (Open DevTools Console for full logs)</h2>
        <div class="status warning">
            ‚ö†Ô∏è Open Chrome DevTools ‚Üí Application ‚Üí Service Workers<br>
            ‚ö†Ô∏è Open Chrome DevTools ‚Üí Console ‚Üí Filter by "[SW]"
        </div>
    </div>

    <script>
        // 1. Check SW Registration
        async function checkSWStatus() {
            const output = document.getElementById('sw-status');
            
            if (!('serviceWorker' in navigator)) {
                output.innerHTML = '<div class="status error">‚ùå Service Workers not supported</div>';
                return;
            }

            try {
                const registration = await navigator.serviceWorker.getRegistration();
                
                if (!registration) {
                    output.innerHTML = '<div class="status error">‚ùå No SW registered</div>';
                    return;
                }

                const sw = registration.active || registration.installing || registration.waiting;
                
                output.innerHTML = `
                    <div class="status">
                        ‚úÖ SW Registered<br>
                        State: ${registration.active ? 'üü¢ ACTIVE' : registration.installing ? 'üü° INSTALLING' : 'üü† WAITING'}<br>
                        Scope: ${registration.scope}<br>
                        Update found: ${registration.waiting ? 'Yes (refresh to activate)' : 'No'}<br>
                        Script URL: ${sw?.scriptURL || 'Unknown'}
                    </div>
                `;
            } catch (e) {
                output.innerHTML = `<div class="status error">‚ùå Error: ${e.message}</div>`;
            }
        }

        // 2. Check Caches
        async function checkCaches() {
            const output = document.getElementById('cache-info');
            
            try {
                const cacheNames = await caches.keys();
                
                if (cacheNames.length === 0) {
                    output.innerHTML = '<div class="status warning">‚ö†Ô∏è No caches found</div>';
                    return;
                }

                let html = '<div class="status">‚úÖ Found ' + cacheNames.length + ' caches:</div><pre>';
                
                for (const name of cacheNames) {
                    const cache = await caches.open(name);
                    const keys = await cache.keys();
                    html += `\n${name}: ${keys.length} entries`;
                    
                    // Show first 3 URLs
                    if (keys.length > 0) {
                        html += '\n  Sample URLs:';
                        for (let i = 0; i < Math.min(3, keys.length); i++) {
                            html += `\n    - ${keys[i].url}`;
                        }
                    }
                }
                
                html += '</pre>';
                output.innerHTML = html;
            } catch (e) {
                output.innerHTML = `<div class="status error">‚ùå Error: ${e.message}</div>`;
            }
        }

        // 3. Test API Fetch
        async function testAPIFetch() {
            const output = document.getElementById('fetch-result');
            output.innerHTML = '<div class="status">Testing API fetch...</div>';
            
            try {
                const start = performance.now();
                const response = await fetch('/api/peanut/user/get-user-from-cookie', {
                    credentials: 'include'
                });
                const elapsed = Math.round(performance.now() - start);
                
                const fromCache = response.headers.get('x-cache') || 'Unknown';
                const age = response.headers.get('age') || 'Unknown';
                
                output.innerHTML = `
                    <div class="status ${response.ok ? '' : 'error'}">
                        ${response.ok ? '‚úÖ' : '‚ùå'} Response: ${response.status} ${response.statusText}<br>
                        ‚è±Ô∏è Time: ${elapsed}ms ${elapsed < 100 ? '(likely cached!)' : ''}<br>
                        üì¶ Cache: ${fromCache}<br>
                        üïê Age: ${age}s<br>
                        <br>
                        üí° Check DevTools Console for [SW] logs
                    </div>
                    <pre>${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}</pre>
                `;
            } catch (e) {
                output.innerHTML = `<div class="status error">‚ùå Error: ${e.message}</div>`;
            }
        }

        // 4. Force Update
        async function forceUpdate() {
            const registration = await navigator.serviceWorker.getRegistration();
            if (registration) {
                await registration.update();
                alert('SW update triggered. Check status.');
                checkSWStatus();
            }
        }

        // 5. Unregister
        async function unregisterSW() {
            if (confirm('Unregister Service Worker? (Good for testing fresh registration)')) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    await registration.unregister();
                    alert('SW unregistered. Reload page to re-register.');
                    location.reload();
                }
            }
        }

        // 6. Clear Caches
        async function clearAllCaches() {
            if (confirm('Clear all caches?')) {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                alert('All caches cleared!');
                checkCaches();
            }
        }

        // 7. Simulate Offline
        async function testOfflineMode() {
            alert('Go to DevTools ‚Üí Network ‚Üí Check "Offline" checkbox, then click "Test User API"');
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            checkSWStatus();
            checkCaches();
        });

        // Listen for SW messages
        navigator.serviceWorker.addEventListener('message', (event) => {
            console.log('[PAGE] Received message from SW:', event.data);
        });
    </script>
</body>
</html>

